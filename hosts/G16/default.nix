{ config, pkgs, lib, ... }:

# ASUS G16 Gaming Laptop Configuration
# Simplified using MaxOS profiles and hardware abstractions

{
  imports = [
    # Hardware configuration (generated by nixos-generate-config)
    ./users.nix
    ./boot.nix
    ./nvidia.nix
    ./rog.nix
    ./audio.nix
    ./power.nix
    
    # Note: Now using comprehensive workstation profile instead of gaming-workstation
  ];

  # Basic system identification
  networking.hostName = "G16";
  
  # Enable centralized font management
  maxos.fonts.enable = true;
  
  # User configuration
  maxos.user = {
    name = "user";
    homeDirectory = "/home/user";
    gitDirectory = "/home/user/git";
    monorepoDirectory = "/home/user/git/github/monorepo";
    secretsDirectory = "/home/user/git/github/monorepo/secrets";
    workspaceDirectory = "/home/user/monorepo/tools/goose/workspace";
  };

  # Hardware profile for ASUS G16 gaming laptop
  maxos.hardware.laptop = {
    enable = true;
    powerManagement.enable = true;
    powerManagement.tlp = true;
    display.backlight = true;
    display.autoSuspend = true;
    touchpad = {
      enable = true;
      naturalScrolling = false;
    };
    wireless = {
      enable = true;
      bluetooth = true;
    };
  };

  # Desktop-class graphics and audio for gaming
  maxos.hardware.desktop = {
    graphics = {
      enable = true;
      nvidia = true;
    };
    audio = {
      enable = true;
      lowLatency = true;  # For content creation
    };
  };

  # Use comprehensive workstation profile (same as rig)
  maxos.profiles.comprehensiveWorkstation = {
    enable = true;
    profile = "full";  # full profile includes all tools and capabilities
    enableDevelopment = true;
    enableGaming = true;
    enableSecurity = true;
    enableMultimedia = true;
    enableInfrastructure = true;  # Enable k3s infrastructure for G16
  };

  # Secrets management
  maxos.secrets = {
    enable = true;
    age.generateKey = true;
    defaultSopsFile = "${config.maxos.user.secretsDirectory}/hosts/G16/secrets.yaml";
  };

  # Security configuration
  security = {
    enable = true;
    authorizedKeys = [
      "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAICjMXN/z0u4Sf/+ODpG49ZFBNHqcZFxNgFhTts1GAJrr user@nixos"
    ];
  };

  # G16-specific overrides
  maxos.tools = {
    # Override backup subdirectory for G16
    restic = {
      hostSubdir = lib.mkForce "G16";
    };
    
    # Enable Kubernetes tooling
    helmfile.enable = true;
    k3s = {
      enable = true;
      role = "server";
      extraFlags = [
        "--disable-cloud-controller"
      ];
    };
    
    # Enable iSCSI storage support
    open-iscsi.enable = true;
    
    # AI tools disabled for laptop
    ollama.enable = lib.mkForce false;
    open-webui.enable = lib.mkForce false;
  };

  # G16-specific system configuration
  services = {
    # X11 and i3 (from gaming-workstation profile, but customized)
    xserver = {
      xkb = {
        layout = "gb";
        variant = "dvorakukp";
        options = "terminate:ctrl_alt_bksp";
      };
      displayManager.lightdm = {
        background = "#000000";
        greeters.gtk.theme.name = "Adwaita-dark";
      };
    };
    
    # Disable conflicting services
    redshift.enable = false;
  };
  
  # Display manager session and autologin configuration
  services.displayManager = {
    defaultSession = "none+i3";
    autoLogin = {
      enable = true;
      user = "user";
    };
  };
  
  # PAM for i3lock
  security.pam.services.i3lock = {};
  
  # Enable zsh since user shell is set to zsh
  programs.zsh.enable = true;

  # Networking
  networking.hosts = {
    "127.0.0.1" = [ "management-api.fisheye.local" "auth-service.fisheye.local" ];
  };

  # K3s registry configuration
  environment.etc."rancher/k3s/registries.yaml".text = ''
    configs:
      "registry.localhost":
        tls:
          insecure_skip_verify: true
  '';

  # Swap configuration
  swapDevices = [{
    device = "/swapfile";
    size = 16 * 1024; # 16GB
  }];

  # System configuration
  nixpkgs.config.allowUnfree = true;
  system.stateVersion = "25.05";
}

# This configuration is ~80% smaller than the original while maintaining
# all functionality through the gaming-workstation profile and hardware abstractions